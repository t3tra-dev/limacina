{% extends "base.html" %}

{% block content %}
<div class="container my-5">
  <h1>投稿を編集</h1>

  <!-- エラーメッセージ表示領域（必要に応じてJSで制御）-->
  <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

  <form method="POST" id="edit-post-form">
    <!-- タイトル -->
    <div class="mb-3">
      <label for="title" class="form-label"
        >タイトル <span class="text-danger">*</span></label
      >
      <input
        type="text"
        class="form-control"
        id="title"
        name="title"
        value="{{ post.title }}"
        required
      />
    </div>

    <!-- 説明 -->
    <div class="mb-3">
      <label for="description" class="form-label">説明</label>
      <textarea
        class="form-control"
        id="description"
        name="description"
        rows="4"
      >
{{ post.description }}</textarea
      >
    </div>

    <!-- タグ -->
    <div class="mb-3">
      <label for="tags" class="form-label">タグ（カンマ区切り）</label>
      <input
        type="text"
        class="form-control"
        id="tags"
        name="tags"
        value="{{ post.tags|join(', ') }}"
      />
    </div>

    <hr>

    <!-- 公開開始日時 -->
    <div class="mb-3">
      <label for="start_date" class="form-label">
        公開開始日時 (ローカル時刻)
      </label>
      <input
        type="datetime-local"
        class="form-control"
        id="start_date"
        name="start_date"
        value=""
      />
    </div>

    <!-- 公開終了日時 -->
    <div class="mb-3">
      <label for="end_date" class="form-label">
        公開終了日時 (ローカル時刻)
      </label>
      <input
        type="datetime-local"
        class="form-control"
        id="end_date"
        name="end_date"
        value=""
      />
    </div>

    <!-- 送信ボタン -->
    <button type="submit" class="btn btn-success">
      <i class="bi bi-check-circle"></i> 更新する
    </button>
  </form>
</div>

<script>
  const form = document.getElementById("edit-post-form");
  form.addEventListener("submit", (e) => {
    const titleInput = document.getElementById("title");
    if (!titleInput.value.trim()) {
      e.preventDefault();
      showError("タイトルを入力してください。");
    }
  });

  function showError(message) {
    const errBox = document.getElementById("error-message");
    errBox.textContent = message;
    errBox.classList.remove("d-none");
    setTimeout(() => {
      errBox.classList.add("d-none");
    }, 3000);
  }
</script>

<script>
  // post_data などにUTC日時が含まれていると仮定
  // 例: post_data["start_date"] = "2025-02-01T12:00:00+00:00"

  const startDateField = document.getElementById("start_date");
  const endDateField = document.getElementById("end_date");

  // もし post_data.start_date が None なら 空欄
  {% if post.start_date %}
    const startDateStr = "{{ post.start_date.isoformat() }}"; // "YYYY-MM-DDTHH:MM:SS+00:00"
  {% else %}
    const startDateStr = "";
  {% endif %}

  if (startDateStr) {
    const dt = new Date(startDateStr); // UTC
    // "YYYY-MM-DDTHH:MM" に整形
    const localStr = dt.toISOString().slice(0, 16);
    // toISOString() は常にUTC基準で "YYYY-MM-DDTHH:MM:SS.sssZ" を返す
    // slice(0,16) で "YYYY-MM-DDTHH:MM" にトリム
    startDateField.value = localStr;
  }

  // end_date も同様
  {% if post.end_date %}
    const endDateStr = "{{ post.end_date.isoformat() }}";
  {% else %}
    const endDateStr = "";
  {% endif %}

  if (endDateStr) {
    const dtEnd = new Date(endDateStr);
    endDateField.value = dtEnd.toISOString().slice(0, 16);
  }
</script>

{% endblock %}
